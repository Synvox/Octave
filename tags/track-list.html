<track-list>
  <track each={ val, i in tracks } index={ i } data={ val }></track>

  <style type="less">

  @colWidth: 20vw;
  track-list {
    color: #333;
    background: white;
    display: block;
    width: 100%;
    white-space: nowrap;
    .cell {
      padding: 8px;
      display: inline-block;
      float: left;
      &:nth-child(1) {
        width: @colWidth * 1.5;
      }
      &:nth-child(2) {
        width: @colWidth;
      }
      &:nth-child(3) {
        //width: @colWidth;
      }
    }
  }
  </style>
  <script>
    var self = this
    self.tracks = [];

    db.allDocs({
      include_docs: true,
      attachments: false,
      limit: 10000
    }).then(function (result) {
      for(var i in result.rows) {
        add(result.rows[i].doc)
      }

      sort();

    }).catch(function (err) {
      console.log(err);
    });

    var changeDebounce = null;
    var changes = db.changes({
      since: 'now',
      live: true,
      include_docs: true
    }).on('change', function(change) {
      add(change.doc);
      if (changeDebounce)
        window.clearTimeout(changeDebounce)
      changeDebounce = window.setTimeout(function(){
        sort();
      },100)
    }).on('complete', function(info) {
      // changes() was canceled
    }).on('error', function (err) {
      console.log(err);
    });

    var add = function(doc){
      self.tracks.push(doc)
    }
    var sort = function(){
      self.tracks.sort(function(a, b){
        var keyA = (a.album)?a.album.trim():'',
            keyB = (b.album)?b.album.trim():''
        if(keyA < keyB) return -1
        if(keyA > keyB) return 1
        return 0
      })

      self.update();
    }

    var wavesurfer = Object.create(WaveSurfer);
    self.on('mount',function(){
      wavesurfer.init({
        container: '#waveform',
        height: 50,
        barWidth: .5,
        progressColor: "#704FDC"
      });
      wavesurfer.on('ready', function () {
        wavesurfer.play();
        App.trigger('track_playing')
      });
      wavesurfer.on('finish',function(){
        App.trigger('play_next')
      })
    })

    var track = null
    var trackIndex = null;
    var updateInterval = null
    App.on('select_track',function(index){
      trackIndex = index

      if (updateInterval)
        window.clearInterval(updateInterval)

      if (!wavesurfer.isPlaying())
        wavesurfer.pause()

      var newData = self.tracks[trackIndex]

      App.trigger('selected_track',newData)

      wavesurfer.load(newData.location);

      self.updateTime()
    })

    self.updateTime = ()=>{
      if (!wavesurfer.isPlaying()) return

      App.trigger('track_time_update',wavesurfer.getCurrentTime(), wavesurfer.getDuration())
      updateInterval = window.setTimeout(self.updateTime,1000)
    }

    App.on('play_pause',()=>{
      if (!wavesurfer.isPlaying()) {
        wavesurfer.play()
        App.trigger('track_playing')
        self.updateTime()
      } else {
        wavesurfer.pause()
        App.trigger('track_pausing')
      }
    })
    App.on('play_next',()=>{
      App.trigger('select_track',trackIndex + 1)
    })
    App.on('play_prev',()=>{
      App.trigger('select_track',trackIndex - 1)
    })

  </script>

</track-list>
