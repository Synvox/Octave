<track-list>
  <track each={ val, i in renderedTracks } index={ i } data={ val }></track>

  <style type="less">

  @colWidth: 20vw;
  track-list {
    color: #333;
    background: white;
    display: block;
    width: 100%;
    white-space: nowrap;
    .cell {
      padding: 8px;
      display: inline-block;
      float: left;
      &:nth-child(1) {
        width: @colWidth * 1.5;
      }
      &:nth-child(2) {
        width: @colWidth;
      }
      &:nth-child(3) {
        //width: @colWidth;
      }
    }
  }
  </style>
  <script>
    var self = this

    self.tracks = [];
    self.renderedTracks = [];

    db.allDocs({
      include_docs: true,
      attachments: false
    }).then(function (result) {
      for(var i in result.rows) {
        add(result.rows[i].doc)
      }
      console.log(self.tracks)
      sort();

    }).catch(function (err) {
      console.log(err);
    });

    var changeDebounce = null;
    var changes = db.changes({
      since: 'now',
      live: true,
      include_docs: true
    }).on('change', function(change) {
      add(change.doc);
      if (changeDebounce)
        window.clearTimeout(changeDebounce)
      changeDebounce = window.setTimeout(function(){
        sort();
      },100)
    }).on('complete', function(info) {
      // changes() was canceled
    }).on('error', function (err) {
      console.log(err);
    });

    var add = function(doc){
      self.tracks.push(doc)
    }

    var sort = function(){
      var get = function(item,key){
        if (typeof item[key] === 'number')
          return item[key];
        else
          return (item[key]) ? ('' + item[key]).trim() : '';
      }

      self.tracks.sort(function(a, b){
        var keyA, keyB;
        keyA = get(a,'artist')+get(a,'album'),
        keyB = get(b,'artist')+get(b,'album')
        if(keyA < keyB) return -1
        if(keyA > keyB) return 1

        // Numeric
        var numA, numB;
        numA = get(a,'trackNumber')
        numB = get(b,'trackNumber')
        if(numA < numB) return -1
        if(numA > numB) return 1

        keyA = get(a,'name')
        keyB = get(b,'name')
        if(keyA < keyB) return -1
        if(keyA > keyB) return 1
        return 0
      })

      fastRender();
    }

    var fastRenderTimeout = null;
    function fastRender(){
      if (fastRenderTimeout)
        window.clearTimeout(fastRenderTimeout);

      self.renderedTracks = [];

      var targetLength = self.tracks.length,
          page = 0,
          pageSize = 500,
          ms = 50;

      function addTracks(){

        var end = (page+1)*pageSize;
        if (end > targetLength) {
          end = targetLength
        } else {
          fastRenderTimeout = window.setTimeout(function(){
            addTracks();
          },ms);
        }

        self.renderedTracks = self.renderedTracks.concat(self.tracks.slice(page*pageSize, end))

        page++;
        self.update();
      }

      addTracks();
    }

    var wavesurfer = Object.create(WaveSurfer);
    self.on('mount',function(){
      wavesurfer.init({
        container: '#waveform',
        height: 50,
        progressColor: "#704FDC"
      });

      wavesurfer.on('ready', function () {
        wavesurfer.play();
        App.trigger('track_playing')
      });

      wavesurfer.on('finish',function(){
        App.trigger('play_next')
      })
    })

    var track = null
    var trackIndex = null;
    var updateInterval = null
    App.on('select_track',function(index){
      if (typeof index !== "number") {
        index = self.tracks.indexOf(index);
      }

      if (index < 0)
        index = self.tracks.length - 1
      if (index >= self.tracks.length)
        index = 0

      trackIndex = index

      if (updateInterval)
        window.clearInterval(updateInterval)

      if (!wavesurfer.isPlaying())
        wavesurfer.pause()

      var newData = self.tracks[trackIndex]

      App.trigger('selected_track',newData)

      wavesurfer.load(newData.location);

      self.updateTime()
    })

    self.updateTime = ()=>{
      if (!wavesurfer.isPlaying()) return

      App.trigger('track_time_update',wavesurfer.getCurrentTime(), wavesurfer.getDuration())
      updateInterval = window.setTimeout(self.updateTime,1000)
    }

    App.on('play_pause',()=>{
      if (!wavesurfer.isPlaying()) {
        wavesurfer.play()
        App.trigger('track_playing')
        self.updateTime()
      } else {
        wavesurfer.pause()
        App.trigger('track_pausing')
      }
    })

    App.on('play_next',()=>{
      App.trigger('select_track',trackIndex + 1)
    })

    App.on('play_prev',()=>{
      App.trigger('select_track',trackIndex - 1)
    })

    App.on('filter_tracks_by',function(arr){
      self.allTracks = self.allTracks || self.tracks.slice(); // Copy
      self.tracks = [];

      self.allTracks.forEach(function(track,index){
        var str = (track.artist + track.album + track.name).toLowerCase();
        var found = true;
        for(var i in arr) {
          var word = arr[i];
          if (str.indexOf(word) === -1) {
            found = false
            continue;
          }
        }

        if (found) {
          self.tracks.push(track);
        }
      })

      fastRender();
    })

  </script>

</track-list>
