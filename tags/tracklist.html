<tracklist>
  <track each={ val, i in renderedTracks } index={ i } data={ val }></track>

  <style type="less">

  @colWidth: 20vw;
  tracklist {
    color: #333;
    background: white;
    display: block;
    width: 100%;
    white-space: nowrap;
    position: absolute;
    top: 110px;
    left: 0px;
    right: 0px;
    bottom: 0px;
    overflow: auto;
    .cell {
      padding: 8px;
      display: inline-block;
      float: left;
      &:nth-child(1) {
        width: @colWidth * 1.5;
      }
      &:nth-child(2) {
        width: @colWidth;
      }
      &:nth-child(3) {
        //width: @colWidth;
      }
    }
  }
  </style>
  <script>
    var self = this
    var $r = $(self.root)

    self.tracks = [];
    self.renderedTracks = [];

    db.allDocs({
      include_docs: true,
      attachments: false
    }).then(function (result) {
      for(var i in result.rows)
        add(result.rows[i].doc)

      sort();
    }).catch(function (err) {
      console.log(err);
    });

    var changeDebounce = null;
    var changes = db.changes({
      since: 'now',
      live: true,
      include_docs: true
    }).on('change', function(change) {
      var index = -1;

      for(var i in self.tracks) {
        if (self.tracks[i]._id === change.doc._id) {
          index = i;
          continue;
        }
      }

      if (index !== -1) {
        // Change
        self.tracks[index] = change.doc;
      } else {
        // Add
        add(change.doc);
      }
      if (changeDebounce)
        window.clearTimeout(changeDebounce)

      changeDebounce = window.setTimeout(function(){
        sort(true); // true = rerun last limit
      },500)

    }).on('complete', function(info) {
      // changes() was canceled
    }).on('error', function (err) {
      console.log(err);
    });

    var add = function(doc){
      self.tracks.push(doc)
    }

    var sort = function(limit){
      var get = function(item,key){
        if (typeof item[key] === 'number')
          return item[key];
        else
          return ((item[key]) ? ('' + item[key]).trim() : '').toLowerCase();
      }

      self.tracks.sort(function(a, b){
        var keyA, keyB;
        keyA = get(a,'artist')+get(a,'album'),
        keyB = get(b,'artist')+get(b,'album')
        if(keyA < keyB) return -1
        if(keyA > keyB) return 1

        // Numeric
        var numA, numB;
        numA = get(a,'trackNumber')
        numB = get(b,'trackNumber')
        if(numA < numB) return -1
        if(numA > numB) return 1

        keyA = get(a,'name')
        keyB = get(b,'name')
        if(keyA < keyB) return -1
        if(keyA > keyB) return 1
        return 0
      })

      fastRender(limit);
    }

    var fastRenderTimeout = null;
    var lastLimit = null;
    function fastRender(limit){
      if (limit === true){ // Rerun last render
        limit = lastLimit
      } else if (limit) {
        lastLimit = limit
      }

      if (fastRenderTimeout)
        window.clearTimeout(fastRenderTimeout);

      self.renderedTracks = [];

      var targetLength = self.tracks.length,
          start = 0,
          pageSize = 80,
          ms = 50;

      function addTracks(){

        var end = start + pageSize;

        if (end > targetLength) {
          end = targetLength
        } else if (!limit || end <= limit) {
          fastRenderTimeout = window.setTimeout(function(){
            addTracks()
          },ms)
        }

        self.renderedTracks = self.renderedTracks.concat(self.tracks.slice(start, end))

        start += pageSize
        pageSize *= 2

        self.update()
      }

      addTracks();
    }

    var wavesurfer = Object.create(WaveSurfer);
    self.on('mount',function(){
      wavesurfer.init({
        container: '#waveform',
        height: 50,
        progressColor: "#704FDC"
      });

      wavesurfer.on('ready', function () {
        wavesurfer.play();
        App.trigger('track_playing')
      });

      wavesurfer.on('finish',function(){
        App.trigger('play_next')
      })
    })

    self.track = null
    var trackIndex = null;
    App.on('select_track',function(index){
      try {
      if (typeof index !== "number") {
        index = self.tracks.indexOf(index);
      }

      if (index < 0)
        index = self.tracks.length - 1
      if (index >= self.tracks.length)
        index = 0

      trackIndex = index

      if (!wavesurfer.isPlaying())
        wavesurfer.pause()

      var newData = self.tracks[trackIndex]

      App.trigger('selected_track',newData)
      self.track = newData;

      wavesurfer.load(newData.location);
      } catch (e) {
        console.error(e)
      }
    })

    App.on('play_pause',()=>{
      if (!wavesurfer.isPlaying()) {
        wavesurfer.play()
        App.trigger('track_playing')
        self.updateTime()
      } else {
        wavesurfer.pause()
        App.trigger('track_pausing')
      }
    })

    App.on('play_next',()=>{
      App.trigger('select_track',trackIndex + 1)
    })

    App.on('play_prev',()=>{
      App.trigger('select_track',trackIndex - 1)
    })

    App.on('filter_tracks_by',function(str){
      var cols = str.split(':'),
          col, arr
      if (cols.length === 2){
        arr = cols[1].toLowerCase().split(' ');
        col = cols[0]
      } else {
        arr = str.toLowerCase().split(' ');
        cols = ['artist','album','name']
      }

      self.allTracks = self.allTracks || self.tracks.slice(); // Copy
      self.tracks = [];

      self.allTracks.forEach(function(track,index){
        var str = ''
        for(var i in cols)
          if (cols[i])
            str += track[cols[i]]


        var str = str.toLowerCase();

        var found = true;
        for(var i in arr) {
          var word = arr[i];
          if (str.indexOf(word) === -1) {
            found = false
            continue;
          }
        }

        if (found) {
          self.tracks.push(track);
        }
      })

      fastRender(100);

      $r.one('scroll',function(){
        fastRender();
      });
    })

  </script>

</tracklist>
